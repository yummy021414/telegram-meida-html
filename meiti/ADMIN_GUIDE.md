# 超管授权功能使用指南

## 📋 功能概述

超管可以为用户授权使用相册功能，授权期限为 1 个月或 3 个月。授权用户到期前一天会自动收到续费提醒。

---

## 🔧 配置超管

### 1. 获取你的 Telegram 用户ID

1. 在 Telegram 中搜索 `@userinfobot`
2. 发送任意消息给这个 Bot
3. 它会返回你的用户ID（例如：`123456789`）

### 2. 配置超管ID

在 `.env` 文件中添加：

```env
ADMIN_USER_IDS=你的用户ID,另一个超管ID
```

**示例：**
```env
ADMIN_USER_IDS=123456789,987654321
```

多个超管ID用逗号分隔。

---

## 🎯 超管命令

### 1. `/admin` - 超管控制面板

打开超管控制面板，显示操作菜单。

**使用：**
```
/admin
```

**功能：**
- 👤 授权用户
- 📋 查看授权列表
- 🔍 查询用户授权

---

### 2. `/authorize <用户ID> <月数>` - 授权用户

为指定用户授权使用相册功能。

**使用：**
```
/authorize 123456789 1   # 授权1个月
/authorize 123456789 3   # 授权3个月
```

**参数：**
- `<用户ID>`：要授权的用户 Telegram ID
- `<月数>`：授权时长，只能是 `1` 或 `3`

**示例：**
```
/authorize 123456789 1
```

**返回：**
```
✅ 授权成功！

用户ID：123456789
授权时长：1个月
到期时间：2024-02-15 10:30:00
```

---

### 3. `/list_auth` - 查看所有授权列表

查看所有有效的用户授权。

**使用：**
```
/list_auth
```

**返回：**
```
📋 授权列表：

✅ 用户ID: 123456789
   开始: 2024-01-15
   到期: 2024-02-15
   剩余: 30天

✅ 用户ID: 987654321
   开始: 2024-01-10
   到期: 2024-04-10
   剩余: 90天
```

---

### 4. `/check_user <用户ID>` - 查询用户授权状态

查询指定用户的授权状态。

**使用：**
```
/check_user 123456789
```

**返回：**
```
👤 用户ID: 123456789
状态: ✅ 有效
开始时间: 2024-01-15 10:30:00
到期时间: 2024-02-15 10:30:00
剩余天数: 30天
```

---

## ⚠️ 授权检查机制

### 用户创建相册时

- **超管**：无需授权，可直接使用
- **普通用户**：需要有效授权才能创建相册
- **授权过期**：无法创建相册，会提示联系管理员续费

### 授权检查点

以下操作会检查用户授权：
1. 点击「📸 创建新相册」按钮
2. 发送 `/new_album` 命令
3. 发送媒体文件（照片/视频）

---

## 🔔 到期提醒机制

### 自动提醒

- **提醒时间**：授权到期前 1 天
- **提醒方式**：Bot 自动发送私信给用户
- **提醒内容**：
  ```
  ⚠️ 授权即将到期提醒

  您的相册功能授权将在明天到期！
  到期时间：2024-02-15 10:30:00

  请及时联系管理员续费，避免影响使用。
  ```

### 提醒任务

- **执行时间**：每天凌晨 2:00
- **检查频率**：每天一次
- **避免重复**：每个用户只提醒一次

---

## 📊 数据库结构

### user_authorizations 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| user_id | INTEGER | 用户ID（唯一） |
| authorized_by | INTEGER | 授权人ID（超管） |
| start_date | TIMESTAMP | 授权开始时间 |
| expire_date | TIMESTAMP | 授权到期时间 |
| is_active | INTEGER | 是否有效（1=有效，0=已撤销） |
| created_at | TIMESTAMP | 创建时间 |
| reminder_sent | INTEGER | 提醒是否已发送（1=已发送，0=未发送） |

---

## 🔄 授权续费

### 方法 1：重新授权（推荐）

直接使用 `/authorize` 命令重新授权，会自动更新现有授权：

```
/authorize 123456789 1
```

### 方法 2：查看到期时间

使用 `/check_user` 查看用户授权状态，确认是否需要续费。

---

## 🛡️ 权限说明

### 超管权限

- ✅ 无需授权即可使用所有功能
- ✅ 可以为其他用户授权
- ✅ 可以查看所有授权列表
- ✅ 可以查询任意用户授权状态

### 普通用户权限

- ✅ 需要授权后才能创建相册
- ✅ 授权有效期内可正常使用
- ✅ 授权过期后无法创建新相册

---

## 📝 使用示例

### 场景 1：为新用户授权

```
超管：/authorize 123456789 1
Bot：✅ 授权成功！

用户ID：123456789
授权时长：1个月
到期时间：2024-02-15 10:30:00
```

### 场景 2：查看所有授权

```
超管：/list_auth
Bot：📋 授权列表：

✅ 用户ID: 123456789
   开始: 2024-01-15
   到期: 2024-02-15
   剩余: 30天
```

### 场景 3：查询用户授权

```
超管：/check_user 123456789
Bot：👤 用户ID: 123456789
状态: ✅ 有效
开始时间: 2024-01-15 10:30:00
到期时间: 2024-02-15 10:30:00
剩余天数: 30天
```

---

## ⚙️ 注意事项

1. **用户ID获取**：用户可以通过 `@userinfobot` 获取自己的ID
2. **授权更新**：如果用户已有授权，重新授权会更新现有授权
3. **授权撤销**：目前需要手动修改数据库，后续可添加撤销命令
4. **到期提醒**：提醒在授权到期前1天的凌晨2点发送
5. **多超管**：可以配置多个超管，用逗号分隔用户ID

---

## 🐛 常见问题

### Q: 如何撤销用户授权？

A: 目前需要手动修改数据库，后续版本会添加 `/revoke` 命令。

### Q: 授权可以延长吗？

A: 可以，使用 `/authorize` 重新授权即可，会自动更新到期时间。

### Q: 用户授权过期后还能查看之前的相册吗？

A: 可以，授权只影响创建新相册，不影响查看已有相册。

### Q: 提醒什么时候发送？

A: 授权到期前1天的凌晨2点自动发送。

---

## 📞 技术支持

如有问题，请联系技术支持。


